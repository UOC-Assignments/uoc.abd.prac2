xquery version "3.0" encoding "UTF-8";
<row>
{
for $row in collection('/PRA2/Collection')//row


where IsInResidence="no" and confirmed_cases max()

return
  <covidquery>
    <AgrupatedData IsInResidence="No" MeasurementDate="">
      <dadesLleida>
        <confirmed_cases> </Confirmed_cases>
        <confirmed_cases_rate> </confirmed_cases_rate>
      </dadesLleida>
      <dadesTarragona>
        <confirmed_cases> </Confirmed_cases>
        <confirmed_cases_rate> </confirmed_cases_rate>
      </dadesTarragona>
      <dadesGirona>
        <confirmed_cases> </Confirmed_cases>
        <confirmed_cases_rate> </confirmed_cases_rate>
      </dadesGirona>
      <dadesBarcelona>
        <confirmed_cases> </Confirmed_cases>
        <confirmed_cases_rate> </confirmed_cases_rate>
      </dadesBarcelona>
    </AgrupatedData>
    <IsolatedData>
      <dadesLleida>
        <confirmed_cases> </Confirmed_cases>
      </dadesLleida>
      <dadesTarragona>
        <confirmed_cases> </Confirmed_cases>
      </dadesTarragona>
      <dadesGirona>
        <confirmed_cases> </Confirmed_cases>
      </dadesGirona>
      <dadesBarcelona>
        <confirmed_cases> </Confirmed_cases>
      </dadesBarcelona>
    <IsolatedData>
   </covidquery>

order by  $doc/confirmed_cases/number() descending"
}
</row>



let $ConfirmedCasesLleida := sum(/response/row/row[idregion=33]/confirmed_cases)
<ConfirmedCases>{$ConfirmedCasesLleida}</ConfirmedCases>
