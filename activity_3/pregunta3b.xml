<--

    Using XBase we need to copy all the files (dadesLleida.xml, dadesTarragona.xml, dadesBarcelona.xml, dadesGirona.xml) into a folder in order to access as a collection
    We need to get the maximum values for each region; the output has two parts:
    
    AgrupatedData, were it has to show the situation for each province at the time where Lleida had the highest confirmed_cases. The format has to be as follows:
    
      - IsInResidence: containing the value at the node with the highest confirmed_cases from dadesLleida.xml
      - MeasuramentData: containing start_date value from the node  with the highest confirmed_cases at dadesLleida.xml
    
      Both, isInresidence and MeasurementData will be used in orderto filter the othe xml files from the other provinces and get the value from confirmed_cases and confirmed_case_rate.
      We have to create the node for each capital LleidaData, TGNData, BCNData and GironaData, for every file we have to create.

    On the other hand at IsolatedData, we need to show for every region the five days containing the highest confirmed_Cases without considering data from the other regions. 
    It's mandatory to get data containing Residence=”No”. Finally we 'll show the values confirmed_cases - start_date.    
-->   
declare variable $lleida := doc("Collection/dadesLleida.xml");
declare variable $tarragona := doc("Collection/dadesTarragona.xml");
declare variable $barcelona := doc("Collection/dadesBarcelona.xml");
declare variable $girona := doc("Collection/dadesGirona.xml");

let $maximlleidaCC := $lleida/response/row/row[confirmed_cases = max($lleida/response/row/row/confirmed_cases)]/confirmed_cases/text()
let $maximlleidaCCR := $lleida/response/row/row[confirmed_cases = max($lleida/response/row/row/confirmed_cases)]/confirmed_cases_rate/text()
let $maximlleidaD := $lleida/response/row/row[confirmed_cases = max($lleida/response/row/row/confirmed_cases)]/start_date/text()
let $maximlleidaR := $lleida/response/row/row[confirmed_cases = max($lleida/response/row/row/confirmed_cases)]/residence/text()

let $maximtarragonaCC := $tarragona/response/row/row[confirmed_cases = max($tarragona/response/row/row/confirmed_cases)]/confirmed_cases/text()
let $maximtarragonaCCR := $tarragona/response/row/row[confirmed_cases = max($tarragona/response/row/row/confirmed_cases)]/confirmed_cases_rate/text()


return 
<COVIDData>
  <AgrupatedData Isinresidences="{$maximlleidaCC/residence}" MeasurementDate="{$maximlleidaCC/start_date}">
    <LleidaData>
      <confirmed_cases>{$maximlleidaCC}</confirmed_cases>
      <confirmed_cases_rate>{$maximlleidaCCR}</confirmed_cases_rate>
    </LleidaData>
    <TGNData>
      <confirmed_cases>{$maximtarragonaCC}</confirmed_cases>
      <confirmed_cases_rate>{$maximtarragonaCCR}</confirmed_cases_rate>
    </TGNData>
  </AgrupatedData>

    <-- In every region (using for) we filter for every row node which has residence value as "No" through the clause "where" then as we have to provide the 5 highest confirmed cases 
    we first sort the output using the clause "order by" and finally we just take the first five using "count" reaching 5.
    From here we return the information using the requested output format, showing the confirmed cases and it's start_date from the own region
    -->  
    <IsolatedData>
    <LleidaData>
      {
      for $dadesLleida in $lleida//row
      where $dadesLleida/residence = 'No'
      order by xs:integer($dadesLleida/confirmed_cases) descending
      count $item
      where $item le 5
      return
       <ConfirmedCases>{$dadesLleida/confirmed_cases/text(), '-', $dadesLleida/start_date/text()}</ConfirmedCases>
      }
    </LleidaData>    
     <TGNData>
      {
      for $dadesTarragona in $tarragona//row
      where $dadesTarragona/residence = 'No'
      order by xs:integer($dadesTarragona/confirmed_cases) descending
      count $item
      where $item le 5
      return
        <ConfirmedCases>{$dadesTarragona/confirmed_cases/text(), '-', $dadesTarragona/start_date/text()}</ConfirmedCases>
      }
    </TGNData>
    <BCNData>
      {
      for $dadesBarcelona in $barcelona//row
      where $dadesBarcelona/residence = 'No'
      order by xs:integer($dadesBarcelona/confirmed_cases) descending
      count $item
      where $item le 5
      return
        <ConfirmedCases>{$dadesBarcelona/confirmed_cases/text(), '-', $dadesBarcelona/start_date/text()}</ConfirmedCases>
      }
    </BCNData>
    <GironaData>
      {
      for $dadesGirona in $girona//row
      where $dadesGirona/residence = 'No'
      order by xs:integer($dadesGirona/confirmed_cases) descending
      count $item
      where $item le 5
      return
        <ConfirmedCases>{$dadesGirona/confirmed_cases/text(), '-', $dadesGirona/start_date/text()}</ConfirmedCases>
      }
    </GironaData>
  </IsolatedData>
</COVIDData>
