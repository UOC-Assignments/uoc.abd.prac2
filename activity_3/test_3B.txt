declare variable $docLleida := doc("dadesLleida.xml");
declare variable $docTarragona := doc("dadesTarragona.xml");
let $max := max($docLleida/response/row/row/confirmed_cases)
for $L in $docLleida /response/row/row
where $L/confirmed_cases = $max
let $start_date := $L/start_date
let $tarragonaCases := $docTarragona/response/row/row[start_date = $L/start_date and confirmed_cases = max(.)]/confirmed_cases/text()
return 
<COVID>
	<agrupatedData>
		<LleidaData>
			<ConfirmedCases>{$L/confirmed_cases/text()}</ConfirmedCases>
			<ConfirmedCasesRate>{$L/confirmed_cases_rate/text()}</ConfirmedCasesRate>
			<startDate>{$L/start_date/text()}</startDate>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases>{$tarragonaCases/text()}</ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</BarcelonaData>
	</agrupatedData>
	<isolatedData>
		<LleidaData>
			<ConfirmedCases></ConfirmedCases>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases></ConfirmedCases>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
		</BarcelonaData>
	</isolatedData>
</COVID>