declare variable $docLleida := doc("dadesLleida.xml");
declare variable $docTarragona := doc("dadesTarragona.xml");
let $max := max($docLleida/response/row/row/confirmed_cases)
for $L in $docLleida /response/row/row
where $L/confirmed_cases = $max
let $T := $docTarragona/response/row/row[start_date = $L/start_date]
return 
<COVID>
	<agrupatedData isInResidences="{$L/residence/text()}" MeasurementDate="{$L/start_date/text()}">
		<LleidaData>
			<ConfirmedCases>{$L/confirmed_cases/text()}</ConfirmedCases>
			<ConfirmedCasesRate>{$L/confirmed_cases_rate/text()}</ConfirmedCasesRate>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases>{$T[confirmed_cases = max($T/confirmed_cases)]/confirmed_cases/text()}</ConfirmedCases>
			<ConfirmedCasesRate>{$T[confirmed_cases = max($T/confirmed_cases)]/confirmed_cases_rate/text()}</ConfirmedCasesRate>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</BarcelonaData>
	</agrupatedData>
	<isolatedData>
		<LleidaData>
			<ConfirmedCases></ConfirmedCases>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases></ConfirmedCases>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
		</BarcelonaData>
	</isolatedData>
</COVID>