 (:
 ################################################################################
 #                                                                              #
 #                       UOC - Open University of Catalonia                     #
 #                                                                              #
 ################################################################################

 ################################################################################
 #                                                                              #
 #                             DATABASE ARCHITECTURES                           #
 #                                  (ABD - 05607)                               #
 #                                                                              #
 #                             PRACTICAL ASSIGNMENT #2                          #
 #                                                                              #
 #                       STUDENTS: Del Blanco GarcÃ­a, Carles                    #
 #                                 Bericat Ruz, Jordi                           #
 #                                                                              #
 #                           TERM: Autumn 2020/21                               #
 #                    GITHUB REPO: UOC-Assignments/uoc.abd.prac2                #
 #                    FILE 1 OF n: activity_3/activity_3B.txt                   #
 #                        VERSION: 1.0                                          #
 #                                                                              #
 ################################################################################

 ################################################################################
 #                                                                              #
 #  DESCRIPTION: ACTIVITY 3-B                                                   #
 #                                                                              #
 ################################################################################

(SEE COMMENTS AT THE ASSIGMENT'S PDF MEMORY, SECTION 3-B)

xQuery sentence:)

v1.0 (TEST) -> I got a first approach of the "agrupatedData" part that already works 
               to retrieve the confirmed_cases from Tarragona's same week when there's 
               a max in Lleida. However, I think I must cap-out the results to the 
               maximum value from the filtered ones, since I get two results for Tarragona. 
               For example, there are two nodes for the 15/07/2020 date, one with 0 
               confirmed_cases (residence = no) and another with 75 cases (residence = yes). 
               I guess we should take the highest.

declare variable $docLleida := doc("dadesLleida.xml");
declare variable $docTarragona := doc("dadesTarragona.xml");
let $max := max($docLleida/response/row/row/confirmed_cases)
for $L in $docLleida /response/row/row
where $L/confirmed_cases = $max
for $T in $docTarragona /response/row/row
where $T/start_date = $L/start_date
return 
<COVID>
	<agrupatedData isInResidences="{$L/residence/text()}" MeasurementDate="{$L/start_date/text()}">
		<LleidaData>
			<ConfirmedCases>{$L/confirmed_cases/text()}</ConfirmedCases>
			<ConfirmedCasesRate>{$L/confirmed_cases_rate/text()}</ConfirmedCasesRate>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases>{$T/confirmed_cases/text()}</ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
			<ConfirmedCasesRate></ConfirmedCasesRate>
		</BarcelonaData>
	</agrupatedData>
	<isolatedData>
		<LleidaData>
			<ConfirmedCases></ConfirmedCases>
		</LleidaData>
		<TarragonaData>
			<ConfirmedCases></ConfirmedCases>
		</TarragonaData>
		<GironaData>
			<ConfirmedCases></ConfirmedCases>
		</GironaData>
		<BarcelonaData>
			<ConfirmedCases></ConfirmedCases>
		</BarcelonaData>
	</isolatedData>
</COVID>